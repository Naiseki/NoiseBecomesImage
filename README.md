# Noise Becomes Image

ランダムに配置された粒子が、スコア場のみを参照して移動し、元画像の構造と色を再構成する過程を可視化するWebアプリケーション。

## 概要

このプロジェクトは、拡散モデルのスコアベースアプローチを可視化します。重要な制約として、**サンプリング中は元画像を直接参照せず、事前計算したスコア場のみを使用**します。

### 主な特徴

- 画像から密度スコア場と色スコア場を事前計算
- ランジュバンダイナミクスによる粒子の位置更新
- Softmax関数による目標色への指数緩和
- 確率的モード（ノイズあり）と決定的モード（DDIM）のサポート
- リアルタイムでの可視化とGIF出力

## インストール

### 必要要件

- Python 3.10以上
- uv（パッケージマネージャー）

### セットアップ

```bash
# リポジトリをクローン
git clone <repository-url>
cd NoiseBecomesImage

# 依存関係をインストール
uv sync
```

## 使い方

### アプリケーションの起動

```bash
uv run streamlit run src/main.py
```

ブラウザが自動的に開き、`http://localhost:8501` でアプリケーションが起動します。

### 基本的な使い方

1. **画像をアップロード**: PNG/JPEG形式の画像をアップロード（最大512x512にリサイズされます）
2. **パラメータ調整**: サイドバーで各種パラメータを調整
3. **粒子システムを初期化**: ボタンをクリックして粒子をランダムに配置
4. **実行**: シミュレーションを開始し、リアルタイムで再構成過程を観察
5. **GIFをダウンロード**: 完了後、アニメーションGIFをダウンロード

## パラメータ

### 粒子システムのパラメータ

- **粒子数** (1,000-50,000): シミュレーションで使用する粒子の数
- **位置更新ステップ (η)** (0.01-2.0): 粒子の位置更新の大きさ
- **色更新ステップ (α)** (0.01-1.0): 粒子の色更新の速度
- **色の鮮やかさ (β)** (1.0-15.0): 色の鮮やかさを制御（大きいほど鮮やか）
- **ノイズ強度 (σ0)** (0.0-2.0): 確率的モードでのノイズの強さ
- **総ステップ数** (50-1,000): シミュレーションの総ステップ数

### 描画パラメータ

- **モード**: stochastic（ノイズあり）/ deterministic（DDIM、ノイズなし）
- **ぼかし強度** (0.5-5.0): 描画時のガウシアンぼかし
- **勾配計算時のぼかし** (0.5-3.0): スコア場計算時のぼかし
- **GIF保存間隔** (1-10): 何ステップごとにGIFフレームを保存するか

## 数式

### スコア場の構築

**密度スコア場**:
```
Y(x,y) = 0.299R + 0.587G + 0.114B
p(x,y) = (Y + ε) / Σ(Y + ε)
L(x,y) = log(p(x,y))
score_pos = ∇L(x,y)
```

**色スコア場**:
```
p_c(x,y) = (C + ε) / Σ(C + ε)  for c ∈ {r, g, b}
L_c = log(p_c)
```

### 粒子の更新

**位置更新**:
```
x_{t+1} = x_t + η * score_pos(x_t) + σ(t) * N(0,1)
σ(t) = σ0 * (1 - t/T)
```

**色更新**:
```
μ_c(x) = exp(β * L_c) / Σ_c exp(β * L_c)
c_{t+1} = c_t + α * (μ(x_t) - c_t)
```

## プロジェクト構造

```
NoiseBecomesImage/
├── .claude/
│   └── CLAUDE.md           # プロジェクト仕様
├── src/
│   ├── main.py             # Streamlitアプリケーション
│   ├── utils.py            # 画像読み込みユーティリティ
│   ├── score_field.py      # スコア場計算
│   ├── particle_system.py  # 粒子システムロジック
│   └── renderer.py         # レンダリングとGIF生成
├── pyproject.toml          # プロジェクト設定
└── README.md
```

## 期待される動作

- **初期**: カラフルなノイズ雲が画面全体に広がる
- **序盤〜中盤**: 粒子が構造のある領域に集まり始め、色も収束開始
- **中盤〜終盤**: 輪郭が明確になり、元画像に近い配色が出現
- **終盤**: 元画像の構造と色が高精度で再現される

## 技術詳細

### スコア場のみを使用する理由

このアプリケーションの重要な制約は、**サンプリング中に元画像を直接参照しない**ことです。これは拡散モデルの原理を正確に表現するためです：

1. スコア場（勾配場）は前処理で一度だけ計算
2. 粒子更新時は、このスコア場のみを参照
3. 元画像のピクセル値には一切アクセスしない

### 実装の工夫

- **バイリニア補間**: 連続的な粒子位置からスコア値を滑らかに補間
- **Softmax目標色**: log確率密度から確率的に目標色を計算
- **指数緩和**: 急激な色変化を避け、滑らかに収束
- **ノイズスケジュール**: 時間とともにノイズを減衰

## ライセンス

MIT License

## 参考文献

- Score-Based Generative Modeling through Stochastic Differential Equations
- Denoising Diffusion Probabilistic Models
- Denoising Diffusion Implicit Models (DDIM)
